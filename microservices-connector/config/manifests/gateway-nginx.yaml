---
# Source: nginx/templates/configmap.yaml
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-nginx-template-config
  labels:
    helm.sh/chart: nginx-1.4.0
    app.kubernetes.io/name: nginx
    app.kubernetes.io/instance: gateway-nginx
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
data:
  default.conf.template: |
    # Default server configuration
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
    
        # Server name and root settings
        server_name _;
        root /usr/share/nginx/html;
        index index.html index.htm;
    
        # Default headers
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
    
        # Timeouts
        client_max_body_size 10G;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;
    
        # Root path goes to UI
        location / {
            proxy_pass http://${FRONTEND_SERVICE_IP}:${FRONTEND_SERVICE_PORT};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    
        # Health check endpoint
        location /v1/health_check {
            return 200 'healthy\n';
            add_header Content-Type text/plain;
        }
    
        # ChatQnA service
        location /v1/chatqna {
            proxy_pass http://${CHATQNA_SERVICE_IP}:${CHATQNA_SERVICE_PORT}/v1/chatqna;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            gzip off;
        }
    
        # CodeGen service
        location /v1/codegen {
            proxy_pass http://${CODEGEN_SERVICE_IP}:${CODEGEN_SERVICE_PORT}/v1/codegen;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            gzip off;
        }
    
        # DocSum service
        location /v1/docsum {
            proxy_pass http://${DOCSUM_SERVICE_IP}:${DOCSUM_SERVICE_PORT}/v1/docsum;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            gzip off;
        }
    
        # DataPrep service
        location /v1/dataprep {
            proxy_pass http://${DATAPREP_SERVICE_IP}:${DATAPREP_SERVICE_PORT}/v1/dataprep;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 6000;
            proxy_send_timeout 6000;
            proxy_read_timeout 6000;
            send_timeout 6000;
        }
    
        # Chathistory service
        location /v1/chathistory {
            proxy_pass http://${CHATHISTORY_SERVICE_IP}:${CHATHISTORY_SERVICE_PORT}/v1/chathistory;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            gzip off;
        }
    
        # Prompt service
        location /v1/prompt {
            proxy_pass http://${PROMPT_SERVICE_IP}:${PROMPT_SERVICE_PORT}/v1/prompt;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            gzip off;
        }
    
        # Keycloak service
        location /auth {
            proxy_pass http://keycloak.keycloak.svc.cluster.local:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            gzip off;
        }
    
        # Error pages
        error_page 404 /404.html;
        location = /404.html {
            root /usr/share/nginx/html;
        }
    
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
---
# Source: nginx/templates/service.yaml
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

apiVersion: v1
kind: Service
metadata:
  name: gateway-nginx
  labels:
    helm.sh/chart: nginx-1.4.0
    app.kubernetes.io/name: nginx
    app.kubernetes.io/instance: gateway-nginx
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: nginx
      protocol: TCP
      name: nginx
  selector:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/instance: gateway-nginx
---
# Source: nginx/templates/deployment.yaml
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-nginx
  labels:
    helm.sh/chart: nginx-1.4.0
    app.kubernetes.io/name: nginx
    app.kubernetes.io/instance: gateway-nginx
    app.kubernetes.io/version: "1.1"
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: nginx
      app.kubernetes.io/instance: gateway-nginx
  template:
    metadata:
      
      labels:
        helm.sh/chart: nginx-1.4.0
        app.kubernetes.io/name: nginx
        app.kubernetes.io/instance: gateway-nginx
        app.kubernetes.io/version: "1.1"
        app.kubernetes.io/managed-by: Helm
    spec:      
      serviceAccountName: default
      securityContext:
        {}
      containers:
        - name: nginx
          command:
            - /bin/sh
            - -c
          args:
            - |
              # Environment variables are provided by the E2E chart's ConfigMap
              # Example variables: FRONTEND_SERVICE_IP, FRONTEND_SERVICE_PORT, CHATQNA_SERVICE_IP, etc.
              envsubst '${FRONTEND_SERVICE_IP} ${FRONTEND_SERVICE_PORT} ${CHATQNA_SERVICE_IP} ${CHATQNA_SERVICE_PORT} ${CODEGEN_SERVICE_IP} ${CODEGEN_SERVICE_PORT} ${DOCSUM_SERVICE_IP} ${DOCSUM_SERVICE_PORT} ${DATAPREP_SERVICE_IP} ${DATAPREP_SERVICE_PORT} ${CHATHISTORY_SERVICE_IP} ${CHATHISTORY_SERVICE_PORT} ${PROMPT_SERVICE_IP} ${PROMPT_SERVICE_PORT}' < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf &&
              nginx -g 'daemon off;'
          envFrom:
            - configMapRef:
                name: gateway-nginx-nginx-config
                optional: true
          securityContext:
            capabilities:
              add:
              - CHOWN
              - DAC_OVERRIDE
              - NET_BIND_SERVICE
              - SETGID
              - SETUID
              drop:
              - ALL
            readOnlyRootFilesystem: false
            runAsNonRoot: false
            runAsUser: 0
            seccompProfile:
              type: RuntimeDefault
          image: "opea/nginx:1.4"
          ports:
            - name: nginx
              containerPort: 80
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /v1/health_check
              port: nginx
            initialDelaySeconds: 5
            periodSeconds: 5
          startupProbe:
            failureThreshold: 120
            httpGet:
              path: /v1/health_check
              port: nginx
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/templates/
      volumes:
        - name: nginx-conf
          configMap:
            name: gateway-nginx-template-config
            items:
              - key: default.conf.template
                path: default.conf.template
---
# Source: nginx/templates/horizontal-pod-autoscaler.yaml
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Source: nginx/templates/ingress.yaml
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Source: nginx/templates/serviceaccount.yaml
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
---
# Source: nginx/templates/servicemonitor.yaml
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
